import { Injectable, Logger, OnModuleInit } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { ChatClient } from '@twurple/chat';
import { CommandService } from '../commands/command.service';

@Injectable()
export class TwitchService implements OnModuleInit {
  private chatClient: ChatClient;
  private readonly logger = new Logger(TwitchService.name);

  constructor(private configService: ConfigService, private commandService: CommandService) {
    this.chatClient = new ChatClient({
      authProvider: {
        clientId: this.configService.get<string>('TWITCH_CLIENT_ID'),
        accessToken: this.configService.get<string>('TWITCH_ACCESS_TOKEN'),
      },
      channels: [this.configService.get<string>('TWITCH_CHANNEL')],
    });
  }

  async onModuleInit() {
    this.logger.log('âœ… TwitchService - å•Ÿå‹•');

    try {
      await this.chatClient.connect();
      this.logger.log('âœ… Twitch Bot å·²å•Ÿå‹•');
    } catch (error) {
      this.logger.error('âŒ Twitch Bot é€£ç·šå¤±æ•—:', error);
      return;
    }

    this.chatClient.onMessage(async (channel, user, message) => {
      this.logger.debug(`ğŸ“© [${channel}] ${user}: ${message}`);

      try {
        const response = await this.commandService.executeCommand('twitch', message);
        this.logger.debug(`ğŸ” æŒ‡ä»¤åŸ·è¡Œçµæœ: ${response}`);

        if (response) {
          this.chatClient.say(channel, response);
        }
      } catch (cmdError) {
        this.logger.error('âŒ æŒ‡ä»¤åŸ·è¡ŒéŒ¯èª¤:', cmdError);
      }
    });
  }
}
